<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
</head>
<body>

<!-- Navbar -->
<div th:replace="layout/navbar :: navbar"></div>

<div class="container mt-5">
  <h2 class="mb-4">ğŸ“¦ Tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng</h2>

  <!-- ThÃ´ng tin Ä‘Æ¡n hÃ ng -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <p><strong>MÃ£ Ä‘Æ¡n:</strong> <span th:text="${order.id}"></span></p>
      <p><strong>Äá»‹a chá»‰ nháº­n:</strong> <span th:text="${order.shippingAddress}"></span></p>
      <p><strong>Thanh toÃ¡n:</strong> <span th:text="${order.paymentMethod}"></span></p>
      <p><strong>Thá»i gian:</strong> <span th:text="${#temporals.format(order.createdAt, 'HH:mm dd/MM/yyyy')}"></span></p>
    </div>
  </div>

  <!-- Tiáº¿n trÃ¬nh -->
  <h4 class="mb-3">ğŸ“ Tiáº¿n trÃ¬nh váº­n chuyá»ƒn:</h4>
  <div class="progress mb-4" style="height: 30px;">
    <div class="progress-bar"
         role="progressbar"
         id="progressBar"
         th:style="'width:' + ${progressPercent} + '%'"
         th:classappend="${progressColor}"
         th:text="${progressText}">
    </div>
  </div>

  <!-- Danh sÃ¡ch cÃ¡c bÆ°á»›c -->
  <ul class="list-group" id="statusSteps">
    <li class="list-group-item" th:classappend="${order.status.name() == 'PENDING'} ? 'text-success fw-bold' : ''">
      1. Äang xá»­ lÃ½
    </li>
    <li class="list-group-item" th:classappend="${order.status.name() == 'PROCESSING'} ? 'text-success fw-bold' : ''">
      2. TÃ¬m ngÆ°á»i váº­n chuyá»ƒn
    </li>
    <li class="list-group-item" th:classappend="${order.status.name() == 'SHIPPING'} ? 'text-success fw-bold' : ''">
      3. Äang váº­n chuyá»ƒn
    </li>
    <li class="list-group-item" th:classappend="${order.status.name() == 'DELIVERED'} ? 'text-success fw-bold' : ''">
      4. ÄÃ£ giao hÃ ng
    </li>
    <li class="list-group-item" th:classappend="${order.status.name() == 'CANCELLED'} ? 'text-danger fw-bold' : ''">
      âŒ ÄÆ¡n hÃ ng Ä‘Ã£ bá»‹ há»§y
    </li>
  </ul>

  <!-- NÃºt há»§y Ä‘Æ¡n hÃ ng -->
  <div th:if="${order.status.name() == 'PENDING' or order.status.name() == 'PROCESSING'}" class="mt-3">
    <a class="btn btn-danger" th:href="@{/order/cancel/{id}(id=${order.id})}">âŒ Há»§y Ä‘Æ¡n hÃ ng</a>
  </div>

  <!-- ThÃ´ng bÃ¡o Ä‘Ã£ há»§y -->
  <div th:if="${order.status.name() == 'CANCELLED'}" class="alert alert-danger mt-4">
    <strong>âŒ ÄÆ¡n hÃ ng Ä‘Ã£ bá»‹ há»§y.</strong><br>
    <span th:text="'LÃ½ do: ' + ${order.cancelReason}"></span>
  </div>

  <!-- ThÃ´ng bÃ¡o giao thÃ nh cÃ´ng -->
  <div class="alert alert-success mt-4 d-none" id="successAlert">
    âœ… ÄÆ¡n hÃ ng cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c giao thÃ nh cÃ´ng!
  </div>
</div>

<!-- Script -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
  const orderId = `[[${order.id}]]`;
  const progressBar = document.getElementById('progressBar');
  const stepItems = document.querySelectorAll('#statusSteps .list-group-item');
  const successAlert = document.getElementById('successAlert');

  function fetchStatus() {
    fetch('/order/status/api/' + orderId)
            .then(res => res.json())
            .then(data => {
              progressBar.textContent = data.text;
              progressBar.className = 'progress-bar ' + data.color;
              progressBar.style.width = data.percent + '%';

              stepItems.forEach((item, index) => {
                item.classList.remove('text-success', 'fw-bold');
                if (
                        (index === 0 && data.status === 'PENDING') ||
                        (index === 1 && data.status === 'PROCESSING') ||
                        (index === 2 && data.status === 'SHIPPING') ||
                        (index === 3 && data.status === 'DELIVERED')
                ) {
                  item.classList.add('text-success', 'fw-bold');
                }
              });

              if (data.status === 'DELIVERED') {
                successAlert.classList.remove('d-none');
              }

              if (data.status === 'CANCELLED') {
                progressBar.textContent = 'ÄÃ£ há»§y';
                progressBar.className = 'progress-bar bg-danger';
                progressBar.style.width = '100%';
                successAlert.classList.add('d-none');

                stepItems.forEach((item) => {
                  item.classList.remove('text-success', 'fw-bold');
                  if (item.textContent.includes('há»§y')) {
                    item.classList.add('text-danger', 'fw-bold');
                  }
                });
              }
            });
  }

  fetchStatus();
  setInterval(fetchStatus, 5000);
</script>

</body>
</html>
