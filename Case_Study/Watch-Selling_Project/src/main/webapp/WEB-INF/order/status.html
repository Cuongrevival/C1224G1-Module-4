<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Trạng thái đơn hàng</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"/>
</head>
<body>

<!-- Navbar -->
<div th:replace="layout/navbar :: navbar"></div>

<div class="container mt-5">
  <h2 class="mb-4">📦 Trạng thái đơn hàng</h2>

  <!-- Thông tin đơn hàng -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <p><strong>Mã đơn:</strong> <span th:text="${order.id}"></span></p>
      <p><strong>Địa chỉ nhận:</strong> <span th:text="${order.shippingAddress}"></span></p>
      <p><strong>Thanh toán:</strong> <span th:text="${order.paymentMethod}"></span></p>
      <p><strong>Thời gian:</strong> <span th:text="${#temporals.format(order.createdAt, 'HH:mm dd/MM/yyyy')}"></span></p>
    </div>
  </div>

  <!-- Tiến trình -->
  <h4 class="mb-3">📍 Tiến trình vận chuyển:</h4>
  <div class="progress mb-4" style="height: 30px;">
    <div class="progress-bar"
         role="progressbar"
         id="progressBar"
         th:style="'width:' + ${progressPercent} + '%'"
         th:classappend="${progressColor}"
         th:text="${progressText}">
    </div>
  </div>

  <!-- Danh sách các bước -->
  <ul class="list-group" id="statusSteps">
    <li class="list-group-item" th:classappend="${order.status.name() == 'PENDING'} ? 'text-success fw-bold' : ''">
      1. Đang xử lý
    </li>
    <li class="list-group-item" th:classappend="${order.status.name() == 'PROCESSING'} ? 'text-success fw-bold' : ''">
      2. Tìm người vận chuyển
    </li>
    <li class="list-group-item" th:classappend="${order.status.name() == 'SHIPPING'} ? 'text-success fw-bold' : ''">
      3. Đang vận chuyển
    </li>
    <li class="list-group-item" th:classappend="${order.status.name() == 'DELIVERED'} ? 'text-success fw-bold' : ''">
      4. Đã giao hàng
    </li>
    <li class="list-group-item" th:classappend="${order.status.name() == 'CANCELLED'} ? 'text-danger fw-bold' : ''">
      ❌ Đơn hàng đã bị hủy
    </li>
  </ul>

  <!-- Nút hủy đơn hàng -->
  <div th:if="${order.status.name() == 'PENDING' or order.status.name() == 'PROCESSING'}" class="mt-3">
    <a class="btn btn-danger" th:href="@{/order/cancel/{id}(id=${order.id})}">❌ Hủy đơn hàng</a>
  </div>

  <!-- Thông báo đã hủy -->
  <div th:if="${order.status.name() == 'CANCELLED'}" class="alert alert-danger mt-4">
    <strong>❌ Đơn hàng đã bị hủy.</strong><br>
    <span th:text="'Lý do: ' + ${order.cancelReason}"></span>
  </div>

  <!-- Thông báo giao thành công -->
  <div class="alert alert-success mt-4 d-none" id="successAlert">
    ✅ Đơn hàng của bạn đã được giao thành công!
  </div>
</div>

<!-- Script -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
  const orderId = `[[${order.id}]]`;
  const progressBar = document.getElementById('progressBar');
  const stepItems = document.querySelectorAll('#statusSteps .list-group-item');
  const successAlert = document.getElementById('successAlert');

  function fetchStatus() {
    fetch('/order/status/api/' + orderId)
            .then(res => res.json())
            .then(data => {
              progressBar.textContent = data.text;
              progressBar.className = 'progress-bar ' + data.color;
              progressBar.style.width = data.percent + '%';

              stepItems.forEach((item, index) => {
                item.classList.remove('text-success', 'fw-bold');
                if (
                        (index === 0 && data.status === 'PENDING') ||
                        (index === 1 && data.status === 'PROCESSING') ||
                        (index === 2 && data.status === 'SHIPPING') ||
                        (index === 3 && data.status === 'DELIVERED')
                ) {
                  item.classList.add('text-success', 'fw-bold');
                }
              });

              if (data.status === 'DELIVERED') {
                successAlert.classList.remove('d-none');
              }

              if (data.status === 'CANCELLED') {
                progressBar.textContent = 'Đã hủy';
                progressBar.className = 'progress-bar bg-danger';
                progressBar.style.width = '100%';
                successAlert.classList.add('d-none');

                stepItems.forEach((item) => {
                  item.classList.remove('text-success', 'fw-bold');
                  if (item.textContent.includes('hủy')) {
                    item.classList.add('text-danger', 'fw-bold');
                  }
                });
              }
            });
  }

  fetchStatus();
  setInterval(fetchStatus, 5000);
</script>

</body>
</html>
